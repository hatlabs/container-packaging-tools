[Unit]
Description={{ service.description }}
After=docker.service
Requires=docker.service
{% if is_oidc_app %}
After=halos-authelia-container.service
Wants=halos-authelia-container.service
{% endif %}

[Service]
Type=simple
WorkingDirectory={{ service.working_directory }}
ExecStartPre={{ service.working_directory }}/prestart.sh
EnvironmentFile=-{{ service.env_defaults_file }}
EnvironmentFile=-{{ service.env_file }}
EnvironmentFile=-{{ service.runtime_env_file }}
{% if has_routing %}
# Apply routing labels from /run/halos/routing-labels/ if available
# The override file is generated by Traefik prestart from /etc/halos/routing.d/
ExecStart=/bin/sh -c '\
    OVERRIDE=""; \
    [ -f /run/halos/routing-labels/{{ package.app_id }}.yml ] && \
    OVERRIDE="-f /run/halos/routing-labels/{{ package.app_id }}.yml"; \
    docker compose -f docker-compose.yml $$OVERRIDE up'
ExecStop=/bin/sh -c '\
    OVERRIDE=""; \
    [ -f /run/halos/routing-labels/{{ package.app_id }}.yml ] && \
    OVERRIDE="-f /run/halos/routing-labels/{{ package.app_id }}.yml"; \
    docker compose -f docker-compose.yml $$OVERRIDE down'
{% else %}
ExecStart=docker compose up
ExecStop=docker compose down
{% endif %}
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
