[Unit]
Description={{ service.description }}
After=docker.service
Requires=docker.service
{% if is_oidc_app %}
After=halos-authelia-container.service
Wants=halos-authelia-container.service
{% endif %}

[Service]
Type=simple
WorkingDirectory={{ service.working_directory }}
# Sentinel variable to prevent direct docker compose usage (must use systemctl)
Environment=HALOS_SYSTEMD_STARTED=1
ExecStartPre={{ service.working_directory }}/prestart.sh
EnvironmentFile=-{{ service.env_defaults_file }}
EnvironmentFile=-{{ service.env_file }}
EnvironmentFile=-{{ service.runtime_env_file }}
{% if has_routing %}
# Generate routing configuration before starting
# This calls the proxy-specific command provided by the installed proxy package
# (e.g., halos-traefik-container provides the Traefik implementation)
ExecStartPre=/usr/bin/configure-container-routing {{ package.app_id }}
# Apply routing labels from /run/halos/routing-labels/ if available
ExecStart=/bin/sh -c '\
    OVERRIDE=""; \
    [ -f /run/halos/routing-labels/{{ package.app_id }}.yml ] && \
    OVERRIDE="-f /run/halos/routing-labels/{{ package.app_id }}.yml"; \
    docker compose -f docker-compose.yml $$OVERRIDE up'
ExecStop=/bin/sh -c '\
    OVERRIDE=""; \
    [ -f /run/halos/routing-labels/{{ package.app_id }}.yml ] && \
    OVERRIDE="-f /run/halos/routing-labels/{{ package.app_id }}.yml"; \
    docker compose -f docker-compose.yml $$OVERRIDE down'
{% else %}
ExecStart=docker compose up
ExecStop=docker compose down
{% endif %}
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
