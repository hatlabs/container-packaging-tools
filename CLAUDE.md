⚠️ **THESE RULES ONLY APPLY TO FILES IN /container-packaging-tools/** ⚠️

# Container Packaging Tools

Tooling for generating Debian packages from container application definitions.

**Local Instructions**: For environment-specific instructions and configurations, see @CLAUDE.local.md (not committed to version control).

## Git Workflow Policy

**Branch Workflow:** Never push to main directly - always use feature branches and PRs.

**Pre-Push Requirements:** ALWAYS run these checks locally before pushing to PR:
```bash
# Code quality checks
./run lint              # Linter must pass
./run check-format      # Formatting must pass
uvx ty check src/       # Type checker must pass

# Test checks (matching CI)
uv run pytest tests/test_*.py -m "not integration and not install" -q  # Unit tests
uv run pytest tests/test_*.py -m "integration and not install" -q      # Integration tests
```

All checks must pass locally before pushing. This prevents wasting CI resources and iteration cycles.

## Version Management

**Version System:** Unified HaLOS versioning with auto-incrementing revisions.

### Version Components

**VERSION file** (canonical source):
- Contains upstream version only (e.g., `0.2.0`)
- No 'v' prefix, no revision
- Managed by: `./run bumpversion [patch|minor|major]`

**Git tags** (auto-generated by CI):
- Pre-release: `v{upstream}+{N}_pre` (unstable channel, DEP-14 compliant)
- Stable: `v{upstream}+{N}` (stable channel)
- N = auto-calculated from existing git tags
- Note: Underscore used instead of tilde for git tag validity

**Debian package version**:
- Format: `{upstream}-{N}`
- Generated dynamically by CI in `debian/changelog`

**Example version progression**:
```
Git tags:    v0.2.0+1_pre < v0.2.0+1 < v0.2.0+2_pre < v0.2.0+2 < v0.3.0+1_pre < v0.3.0+1
Debian pkgs: 0.2.0-1      = 0.2.0-1 < 0.2.0-2      = 0.2.0-2 < 0.3.0-1      = 0.3.0-1
```
Note: Same .deb binary (0.2.0-N) is used for both pre-release and stable tags

### Version Bump Workflow

**To bump the upstream version:**

```bash
# Bump patch version (0.2.0 -> 0.2.1)
./run bumpversion patch

# Bump minor version (0.2.0 -> 0.3.0)
./run bumpversion minor

# Bump major version (0.2.0 -> 1.0.0)
./run bumpversion major

# Push the automatically created commit
git push origin main
```

**Note:** The working directory must be clean before bumping. bumpversion automatically commits the version change (configured with `commit = True` in `.bumpversion.cfg`).

**What happens automatically:**
1. CI reads VERSION file
2. CI calculates next revision number (N)
3. CI generates `debian/changelog` with version `{upstream}-{N}`
4. CI builds .deb package
5. CI creates pre-release tag `v{upstream}+{N}_pre` with .deb
6. CI creates draft release tag `v{upstream}+{N}` with .deb
7. CI dispatches to apt.hatlabs.fi unstable channel

**To publish a stable release:**
1. Test the unstable package
2. Publish the draft release in GitHub UI
3. `release.yml` dispatches to apt.hatlabs.fi stable channel

### Key Benefits

✅ Auto-incrementing revisions (no manual coordination)
✅ Same .deb binary for unstable and stable
✅ Monotonic version ordering (each build > previous)
✅ Works with semver, date-based, or arbitrary versions
✅ Git-compliant tag names (DEP-14 standard)

### Rebuild Scenario

If you need to rebuild without changing the upstream version:
1. Just push to main
2. CI auto-increments the revision number
3. New build gets version `{upstream}-{N+1}`

### Version Scripts

**`.github/scripts/calculate-revision.sh`**: Query git tags to find next N
**`.github/scripts/generate-changelog.sh`**: Generate debian/changelog dynamically
**`.github/scripts/test-version-handling.sh`**: Test version format and DEP-14 compliance
**`./run bumpversion`**: Manage VERSION file with bumpversion tool

### DEP-14 Compliance

Git tags follow [DEP-14](https://dep-team.pages.debian.net/deps/dep14/) version mangling:
- Underscore (`_`) in git tags represents tilde (`~`) in Debian versions
- Since we use the same .deb for both channels, no unmangling is needed
- Pre-release tags use `_pre` suffix (git-valid) instead of `~pre` (git-invalid)

## Project Purpose

This package provides `generate-container-packages` command that converts simple container app definitions into full Debian packages. The goal is to make it easy for developers to add new container apps without understanding Debian packaging internals.

## Project Status

**Current Phase**: Planning & Initial Development

All development tasks are tracked as GitHub issues. See the [Issues page](https://github.com/hatlabs/container-packaging-tools/issues) for current status.

**Development Phases**:
1. **Core Infrastructure** (Issues #1-6): Validation, loading, and context building
2. **Templates** (Issues #7-13): Jinja2 templates and renderer
3. **Building** (Issues #14-16): Package builder and CLI
4. **Integration Testing** (Issues #17-18): End-to-end tests
5. **Packaging & Documentation** (Issues #19-22): Tool packaging, examples, CI/CD
6. **Polish** (Issues #23-24): Security review and final validation

See [PROJECT_PLANNING_GUIDE.md](../PROJECT_PLANNING_GUIDE.md) in the parent directory for the development workflow.

## Planning Documentation

Important planning documents are in the `docs/` directory:
- @docs/DESIGN.md: High-level design
- @docs/SPEC.md: Technical specification
- @docs/ARCHITECTURE.md: System architecture

## Repository Structure

```
container-packaging-tools/
├── src/
│   └── generate_container_packages/    # Main package
│       ├── __init__.py                 # Package version
│       ├── __main__.py                 # Entry point
│       ├── cli.py                      # Command-line interface
│       ├── validator.py                # Input validation
│       ├── loader.py                   # File loading
│       ├── template_context.py         # Template context builder
│       ├── renderer.py                 # Jinja2 template renderer
│       └── builder.py                  # Package builder
├── schemas/                            # Pydantic models for validation
│   ├── metadata.py                     # metadata.yaml schema
│   └── config.py                       # config.yml schema
├── templates/                          # Jinja2 templates for Debian files
│   ├── debian/
│   │   ├── control.j2
│   │   ├── rules.j2
│   │   ├── postinst.j2
│   │   ├── prerm.j2
│   │   ├── postrm.j2
│   │   ├── changelog.j2
│   │   ├── copyright.j2
│   │   └── compat
│   ├── systemd/
│   │   └── service.j2
│   └── appstream/
│       └── metainfo.xml.j2
├── tests/                              # Test suite
│   ├── fixtures/                       # Test fixtures
│   │   ├── valid/                      # Valid app definitions
│   │   │   ├── simple-app/
│   │   │   └── full-app/
│   │   └── invalid/                    # Invalid app definitions
│   ├── test_models.py                  # Pydantic model tests
│   ├── test_validator.py               # Validation tests
│   ├── test_integration.py             # Integration tests
│   └── test_package_install.py         # Installation tests
├── debian/                             # Debian packaging for this tool
│   ├── control
│   ├── rules
│   ├── install
│   └── ...
├── docs/
│   ├── SPEC.md                         # Technical specification
│   └── ARCHITECTURE.md                 # System architecture
├── pyproject.toml                      # Python packaging config
├── EXAMPLES.md                         # Usage examples
└── README.md                           # Project README
```

## Development

**Tech Stack**:
- Python 3.11+ (targeting Debian stable)
- Pydantic v2 for data validation
- Jinja2 for templating
- PyYAML for YAML parsing
- argparse for CLI (standard library)

**Development Tools**:
- pytest for testing
- ruff for linting and formatting
- ty for type checking (Rust-based Python type checker)
- uv for dependency management (in CI)

**Quick Start with Run Script**:

The `./run` script provides convenient commands for common development tasks.

**IMPORTANT: All development commands run in Docker containers**

First, build the development container:
```bash
./run docker-build   # Build the Debian Trixie development container
```

Then use Docker-based commands for all development tasks:
```bash
# Testing
./run test           # Run all tests in Docker
./run test-coverage  # Run tests with coverage report (80% required)
./run test-unit      # Run unit tests only
./run test-integration  # Run integration tests only

# Code Quality
./run check          # Run all quality checks (lint, format, typecheck)
./run lint           # Run ruff linter
./run lint-fix       # Run linter with auto-fix
./run format         # Format code with ruff
./run check-format   # Check formatting without changes
./run typecheck      # Run ty type checker

# Building
./run build          # Build Debian package in Docker

# Docker Management
./run docker-shell   # Open interactive shell in container
./run docker-clean   # Remove Docker containers and images

# Utilities
./run help           # Show all available commands
```

**Why Docker?**
- Tests require `dpkg-buildpackage` which is not available on all systems (especially macOS)
- Ensures consistent Debian Trixie environment across all developers
- Prevents "works on my machine" issues
- All CI/CD runs in the same Docker environment

**Local Development** (without Docker):
If you want to run tests locally (e.g., for faster iteration), you'll need:
```bash
# Debian/Ubuntu only - install build tools
sudo apt install dpkg-dev debhelper dh-python python3-all

# Install dependencies
uv sync --dev

# Run tests locally (will fail on non-Debian systems)
uv run pytest
```

**Code Quality**:
- Unit tests required for all modules
- Integration tests for full pipeline
- Target >80% code coverage
- All tests must pass before merging

## Building the Package

The tool is packaged as a Debian package using Docker:

```bash
./run build   # Builds in Docker with dpkg-buildpackage
```

Or manually in a Debian/Ubuntu environment:
```bash
dpkg-buildpackage -us -uc
```

The resulting package will be installable on Debian 12+ (Trixie) and Raspberry Pi OS.

## Related

- **Parent**: [../CLAUDE.md](../CLAUDE.md) - Workspace documentation
- **Users**: [halos-marine-containers](https://github.com/hatlabs/halos-marine-containers)
