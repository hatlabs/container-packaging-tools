#!/usr/bin/env bash
#
# usage: ./run command [argument ...]
#
# Commands used during development / CI.
#
# See https://death.andgravity.com/run-sh
# for an explanation of how it works and why it's useful.

# First, set up the environment.
# (Check the notes at the end when changing this.)

set -o nounset
set -o pipefail
set -o errexit

# Enable this to echo commands as they are executed.
#set -o xtrace

# Change the current directory to the project root.
PROJECT_ROOT=${0%/*}
if [[ $0 != $PROJECT_ROOT && $PROJECT_ROOT != "" ]]; then
  cd "$PROJECT_ROOT"
fi
readonly PROJECT_ROOT=$(pwd)

# Store the absolute path to this script (useful for recursion).
readonly SCRIPT="$PROJECT_ROOT/$(basename "$0")"

################################################################################
# Development Commands

function dev:version:bump {
  #@ Bump version (patch/minor/major)
  #@ Category: Development
  local part="${1:-patch}"

  if [[ ! "$part" =~ ^(patch|minor|major)$ ]]; then
    echo "âŒ Error: Version part must be 'patch', 'minor', or 'major'"
    echo "Usage: ./run dev:version:bump [patch|minor|major]"
    return 1
  fi

  echo "ğŸ“¦ Bumping $part version..."

  # Check if bumpversion is available
  if ! command -v bumpversion &> /dev/null; then
    echo "âŒ bumpversion not found. Please install it:"
    echo "   Run: pip3 install --user bump2version"
    echo "   Or: brew install bumpversion (on macOS)"
    return 1
  fi

  # Read current version
  CURRENT_VERSION=$(cat VERSION)

  # Bump version with automatic commit (includes VERSION, pyproject.toml, and __init__.py)
  bumpversion --current-version "$CURRENT_VERSION" \
    --commit \
    --message "chore: bump version to {new_version}" \
    "$part"

  # Read the new version that bumpversion created
  NEW_VERSION=$(cat VERSION)

  # Update debian/changelog and amend the commit
  echo "ğŸ“ Updating debian/changelog to ${NEW_VERSION}-1..."
  docker run --rm \
    -v "$PWD:/workspace" \
    -w /workspace \
    -e DEBEMAIL="matti.airas@hatlabs.fi" \
    -e DEBFULLNAME="Matti Airas" \
    debian:trixie-slim \
    bash -c "apt-get update -qq && apt-get install -y -qq devscripts >/dev/null 2>&1 && dch --newversion '${NEW_VERSION}-1' --distribution unstable 'Version bump to ${NEW_VERSION}'"

  # Amend the commit to include debian/changelog
  git add debian/changelog
  git commit --amend --no-edit

  echo "âœ… Version bump complete: $NEW_VERSION"
  echo ""
  echo "Files updated and committed:"
  echo "  - VERSION"
  echo "  - pyproject.toml"
  echo "  - src/generate_container_packages/__init__.py"
  echo "  - debian/changelog"
  echo ""
  echo "Commit created by bumpversion"
}

################################################################################
# Setup Commands

function dev:setup {
  #@ Install development dependencies
  #@ Category: Development
  echo "ğŸ“¦ Installing dependencies..."
  if command -v uv &> /dev/null; then
    uv pip install -e .[dev]
  else
    pip install -e .[dev]
  fi
  echo "âœ… Setup complete"
}

function dev:clean {
  #@ Clean build artifacts and cache
  #@ Category: Development
  echo "ğŸ§¹ Cleaning..."
  rm -rf build/ dist/ *.egg-info
  rm -rf .pytest_cache .ruff_cache .ty_cache htmlcov/
  rm -rf debian/.debhelper debian/container-packaging-tools debian/files debian/*.substvars
  rm -f ../*.deb ../*.buildinfo ../*.changes
  find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
  find . -type f -name "*.pyc" -delete
  echo "âœ… Cleaned"
}

################################################################################
# Docker Commands

function docker:build {
  #@ Build development Docker image
  #@ Category: Docker
  echo "ğŸ³ Building development Docker image..."
  docker compose -f docker/docker-compose.devtools.yml build devtools
  echo "âœ… Docker image built successfully"
}

function docker:shell {
  #@ Open interactive shell in development container
  #@ Category: Docker
  echo "ğŸš Opening shell in development container..."
  echo "   Working directory: /workspace"
  echo "   Exit with: exit or Ctrl+D"
  echo ""
  docker compose -f docker/docker-compose.devtools.yml run --rm devtools bash
}

function docker:clean {
  #@ Remove development Docker containers and images
  #@ Category: Docker
  echo "ğŸ§¹ Cleaning Docker containers and images..."
  docker compose -f docker/docker-compose.devtools.yml down --rmi all --volumes
  echo "âœ… Docker cleanup complete"
}

################################################################################
# Test Commands (Docker-based)

function test {
  #@ Run all tests in Docker container
  #@ Category: Testing
  echo "ğŸ§ª Running all tests..."
  docker compose -f docker/docker-compose.devtools.yml run --rm devtools \
    bash -c "uv sync --dev && uv run pytest"
}

function test:unit {
  #@ Run unit tests only in Docker container
  #@ Category: Testing
  echo "ğŸ§ª Running unit tests..."
  docker compose -f docker/docker-compose.devtools.yml run --rm devtools \
    bash -c "uv sync --dev && uv run pytest tests/test_*.py -k 'not integration'"
}

function test:integration {
  #@ Run integration tests only in Docker container
  #@ Category: Testing
  echo "ğŸ§ª Running integration tests..."
  docker compose -f docker/docker-compose.devtools.yml run --rm devtools \
    bash -c "uv sync --dev && uv run pytest tests/test_integration*.py"
}

function test:coverage {
  #@ Run tests with coverage report in Docker container
  #@ Category: Testing
  echo "ğŸ§ª Running tests with coverage..."
  docker compose -f docker/docker-compose.devtools.yml run --rm devtools \
    bash -c "uv sync --dev && uv run pytest --cov=src --cov-report=term-missing --cov-report=html"
  echo "âœ… Coverage report generated in htmlcov/"
}

################################################################################
# Code Quality Commands (Docker-based)

function lint {
  #@ Run linter (ruff check) in Docker container
  #@ Category: Quality
  echo "ğŸ” Running linter..."
  docker compose -f docker/docker-compose.devtools.yml run --rm devtools \
    bash -c "uv sync --dev && uv run ruff check src/ tests/"
  echo "âœ… Lint passed"
}

function lint:fix {
  #@ Run linter with auto-fix in Docker container
  #@ Category: Quality
  echo "ğŸ”§ Running linter with auto-fix..."
  docker compose -f docker/docker-compose.devtools.yml run --rm devtools \
    bash -c "uv sync --dev && uv run ruff check --fix src/ tests/"
  echo "âœ… Lint fixes applied"
}

function format {
  #@ Format code (ruff format) in Docker container
  #@ Category: Quality
  echo "âœ¨ Formatting code..."
  docker compose -f docker/docker-compose.devtools.yml run --rm devtools \
    bash -c "uv sync --dev && uv run ruff format src/ tests/"
  echo "âœ… Code formatted"
}

function format:check {
  #@ Check formatting without changes in Docker container
  #@ Category: Quality
  echo "ğŸ” Checking code formatting..."
  docker compose -f docker/docker-compose.devtools.yml run --rm devtools \
    bash -c "uv sync --dev && uv run ruff format --check src/ tests/"
  echo "âœ… Format check passed"
}

function typecheck {
  #@ Run type checker (ty) in Docker container
  #@ Category: Quality
  echo "ğŸ” Type checking..."
  docker compose -f docker/docker-compose.devtools.yml run --rm devtools \
    bash -c "uv sync --dev && uvx ty check"
  echo "âœ… Type check passed"
}

function check {
  #@ Run all quality checks (lint, format, typecheck) in Docker
  #@ Category: Quality
  echo "ğŸ” Running all quality checks..."
  lint
  format:check
  typecheck
  echo "âœ… All checks passed"
}

################################################################################
# Build Commands

function build {
  #@ Build Debian package in Docker container
  #@ Category: Build
  echo "ğŸ—ï¸  Building Debian package..."
  docker compose -f docker/docker-compose.devtools.yml run --rm devtools \
    bash -c "uv sync --dev && dpkg-buildpackage -us -uc -b"
  echo "âœ… Build complete - package at ./container-packaging-tools_0.1.0_all.deb"
}

################################################################################
# Git Commands

function git:status {
  #@ Show git status
  #@ Category: Git
  git status
}

################################################################################
# Help System

function help {
  #@ Show this help message
  #@ Category: Core
  echo "Available commands:"
  echo ""

  # Extract function definitions and their help comments
  awk '/^function / {
    fname = $2
    sub(/[({].*/, "", fname)
    getline
    if ($0 ~ /#@/) {
      desc = $0
      sub(/.*#@ /, "", desc)
      sub(/ *$/, "", desc)
      getline
      if ($0 ~ /#@ Category:/) {
        cat = $0
        sub(/.*Category: /, "", cat)
        sub(/ *$/, "", cat)
        if (!seen[cat]++) categories[++cat_count] = cat
        commands[cat, ++cmd_count[cat]] = fname
        descriptions[cat, cmd_count[cat]] = desc
      }
    }
  }
  END {
    for (i = 1; i <= cat_count; i++) {
      cat = categories[i]
      print "\n" cat ":"
      for (j = 1; j <= cmd_count[cat]; j++) {
        printf "  %-30s %s\n", commands[cat, j], descriptions[cat, j]
      }
    }
  }' "$0"

  echo ""
  echo "Usage: ./run <command> [arguments...]"
}

################################################################################
# Commands end.

# Dispatch to command. A simpler version would be just "$@" (with the quotes!).

TIMEFORMAT=$'\nTask completed in %3lR'
time "${@:-help}"

# Some dev notes for this script.
#
# The commands *require*:
#
# * The current working directory is the project root.
# * The shell options and globals are set as they are.
#
# Inspired by the following:
#  - https://death.andgravity.com/run-sh
#  - http://www.oilshell.org/blog/2020/02/good-parts-sketch.html
#  - https://www.youtube.com/watch?v=SdmYd5hJISM&t=7s
